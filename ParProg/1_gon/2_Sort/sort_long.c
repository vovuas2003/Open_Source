//#define DEBUG 1

#include <mpi.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

int compare(const void *x1, const void *x2) {
    return (*(int*)x1 - *(int*)x2);
}

int check(int *a, int n) {
    long i;
    for(i = 0; i < n - 1; i++) {
        if(compare((const void *)(a + i), (const void *)(a + i + 1)) > 0) {
            return 0;
        }
    }
    return 1;
}

int main(int argc, char *argv[]) {
    int np, rank;
    MPI_Init(&argc, &argv);
    MPI_Comm_size(MPI_COMM_WORLD, &np);
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);
    MPI_Status status;
    if(rank != 0) {
        int len;
        MPI_Recv(&len, 1, MPI_INT, 0, 0, MPI_COMM_WORLD, &status);
        int *a = (int*)malloc(len * sizeof(int));
        if(a == NULL) {
            printf("%d cant alloc space!\n", rank);
            exit(-1);
        }
        MPI_Recv(a, len, MPI_INT, 0, 0, MPI_COMM_WORLD, &status);
        qsort(a, len, sizeof(int), compare);
        MPI_Send(a, len, MPI_INT, 0, 0, MPI_COMM_WORLD);
        free(a);
    } else {
        long i;
        #ifdef DEBUG
        long n = 1000;
        int a[1000] = {5813, 1903, 1415, 5807, 4335, 691, 8896, 9833, 6106, 8127, 9194, 5585, 211, 6152, 4950, 6320, 7043, 2342, 9534, 9270, 1058, 4907, 7365, 4041, 9239, 7785, 1379, 5303, 213, 6979, 3035, 9893, 2983, 9196, 1363, 6569, 9523, 9365, 5431, 5164, 3371, 8536, 9382, 931, 4492, 9176, 9345, 303, 8766, 4694, 7248, 8307, 3022, 6464, 9337, 9274, 2470, 8365, 5921, 9459, 9444, 6013, 1033, 1627, 287, 3342, 5272, 3245, 3122, 2219, 7562, 3941, 6543, 5531, 4591, 2158, 4039, 9779, 5449, 7973, 7562, 6946, 9809, 2154, 8242, 6006, 2, 457, 8106, 245, 1879, 9742, 2338, 3673, 9376, 1677, 712, 2530, 9902, 9789, 1296, 1588, 7346, 7321, 8664, 3829, 6398, 2810, 7943, 2955, 163, 9577, 2715, 6030, 597, 4657, 5173, 4211, 3319, 9862, 8171, 2611, 9984, 4038, 9196, 3413, 3994, 8391, 8501, 4185, 6953, 2436, 709, 7640, 6576, 1682, 5505, 7745, 1166, 7544, 4919, 9373, 894, 7279, 4426, 3765, 4133, 4236, 4005, 5771, 3946, 7608, 9977, 6065, 5146, 227, 7207, 2972, 9696, 417, 453, 4404, 5532, 5952, 1591, 4221, 9184, 2742, 3100, 8737, 3349, 4968, 8772, 2975, 6519, 648, 6911, 8592, 9298, 7562, 8336, 9999, 5330, 3998, 4130, 5404, 5142, 4788, 9826, 4931, 4841, 428, 8989, 5100, 7746, 2689, 476, 8299, 5158, 9797, 4402, 1589, 2841, 2275, 8390, 3769, 7, 4468, 1131, 5419, 516, 7119, 1475, 6493, 9105, 4582, 8801, 2437, 3532, 9730, 4018, 3004, 78, 6046, 800, 5785, 3316, 2099, 683, 4819, 2196, 5288, 7047, 3565, 2039, 8622, 2068, 1153, 7212, 8162, 7338, 5557, 5149, 9785, 1201, 5306, 8198, 8375, 420, 7778, 1421, 3451, 9497, 213, 4377, 2129, 9695, 9547, 8806, 5197, 5535, 430, 8001, 1405, 8743, 1871, 3935, 6187, 7469, 1452, 1344, 5167, 3831, 5165, 4789, 7856, 9195, 8897, 8513, 3214, 5244, 5073, 9359, 3419, 3313, 5602, 5213, 690, 8632, 8888, 193, 2152, 7039, 3339, 4492, 4141, 5214, 2338, 5935, 1621, 6800, 6535, 9810, 606, 2078, 7090, 6943, 6617, 8197, 5260, 3756, 5720, 1856, 9380, 3911, 6484, 9904, 6206, 7833, 4080, 3433, 7828, 9108, 9484, 6733, 6547, 4483, 9670, 1265, 5539, 1927, 8936, 1155, 2285, 2796, 9395, 2876, 8219, 8698, 3575, 2021, 1542, 8362, 1848, 28, 2916, 9759, 9302, 122, 1986, 7424, 81, 8513, 4927, 1497, 5818, 9300, 345, 9679, 2206, 5445, 325, 967, 8609, 986, 6455, 4682, 2241, 7807, 8398, 5430, 8517, 7937, 8064, 29, 7387, 7013, 4155, 367, 1661, 9472, 3664, 7382, 8907, 7946, 2626, 9267, 4321, 7131, 1914, 8998, 5269, 6721, 6483, 7888, 3162, 1313, 1042, 2896, 548, 3912, 5749, 1109, 3067, 6639, 5128, 8484, 4745, 5228, 2482, 3370, 8490, 6914, 7595, 1788, 7141, 1688, 947, 1169, 1763, 3441, 8448, 8678, 7848, 1324, 3404, 1737, 606, 1300, 735, 118, 3098, 454, 6014, 448, 5680, 9812, 1296, 6595, 1739, 4679, 1742, 8627, 582, 9130, 3951, 7738, 7628, 1129, 9101, 5217, 910, 1968, 9824, 1247, 2019, 854, 8912, 6570, 6008, 8083, 6764, 9856, 2481, 4548, 4413, 1883, 1373, 2259, 5789, 4161, 1228, 4055, 1745, 3861, 4514, 8411, 6249, 8443, 737, 308, 3280, 1040, 7987, 3642, 8822, 3503, 1095, 3970, 2254, 6045, 4617, 152, 2103, 8011, 8984, 2820, 8192, 4481, 3152, 7673, 9196, 2530, 6, 3787, 6203, 8005, 1001, 9136, 5996, 5729, 4760, 4916, 2587, 5798, 1111, 7472, 7591, 4812, 6483, 7544, 6596, 5126, 791, 9471, 5413, 7402, 235, 7955, 1942, 375, 7174, 7601, 5070, 296, 3923, 4551, 7519, 9993, 139, 487, 737, 7463, 5260, 9516, 9131, 6143, 6262, 9893, 8181, 8564, 7471, 6821, 5651, 8498, 9501, 4694, 3100, 3710, 8415, 1120, 9248, 4711, 9088, 5508, 6620, 9059, 4780, 7699, 6982, 6349, 8289, 2947, 6647, 2677, 8318, 7755, 8739, 5472, 8045, 7450, 1794, 5147, 351, 8258, 4270, 5571, 5044, 694, 5645, 1015, 148, 4773, 9778, 2952, 6864, 5748, 6611, 829, 7985, 1886, 3939, 4064, 9818, 5338, 4290, 3596, 3244, 1606, 9297, 252, 5463, 5121, 2891, 9874, 4233, 2995, 1782, 540, 3376, 7277, 644, 8556, 6159, 7772, 1899, 4872, 5309, 6868, 2592, 4890, 3843, 8547, 4147, 6770, 8718, 6732, 3624, 4459, 3326, 3799, 4862, 3585, 1741, 9865, 1633, 9719, 4775, 4417, 9032, 9697, 3488, 3493, 8886, 6234, 7933, 3562, 1226, 1435, 4854, 7917, 149, 5111, 2927, 3001, 5355, 2685, 6586, 2885, 155, 6261, 7952, 4680, 6889, 1254, 238, 2261, 7137, 6726, 4354, 7811, 572, 7704, 2792, 5119, 2670, 3142, 443, 8189, 8730, 7687, 7252, 1926, 8563, 726, 9833, 2322, 5307, 9783, 6081, 208, 8405, 6913, 109, 12, 8063, 132, 6218, 2501, 7684, 6955, 7251, 3121, 8988, 5211, 9059, 5365, 1750, 5430, 3064, 6918, 7737, 3356, 1823, 9134, 5790, 5720, 535, 7710, 2253, 9934, 5678, 1531, 1207, 5555, 7739, 7396, 7200, 8318, 6220, 1796, 7249, 1074, 9788, 7141, 7099, 8037, 9871, 3608, 6543, 7985, 3242, 9793, 3276, 7949, 1568, 3563, 862, 9057, 2848, 5994, 3390, 9937, 2911, 9487, 6888, 2245, 3432, 8087, 4903, 9906, 5382, 2101, 3096, 5158, 125, 1029, 3539, 7485, 7967, 4697, 5645, 66, 8328, 2212, 3777, 7728, 5756, 6355, 8900, 6018, 1777, 1007, 1503, 7766, 7999, 6429, 8068, 5764, 6220, 2775, 6787, 8907, 656, 6236, 73, 4645, 2894, 9224, 2766, 1087, 4896, 5151, 3127, 1241, 4930, 2081, 9266, 1193, 5411, 5646, 9326, 5983, 4539, 5101, 1000, 5500, 2859, 9498, 6708, 6494, 6256, 8987, 667, 2844, 3292, 5582, 9268, 5942, 6932, 7138, 9573, 8257, 7697, 1039, 1537, 8379, 6127, 4253, 8665, 2824, 9, 8373, 5786, 7336, 1696, 5680, 2280, 9284, 3988, 330, 2391, 5105, 2667, 4368, 4884, 2841, 2738, 3287, 5614, 7127, 588, 4839, 4224, 5138, 8081, 3229, 8947, 7547, 8449, 9784, 4745, 629, 9784, 2562, 1703, 5154, 1884, 573, 492, 3840, 9571, 7102, 6, 1307, 4108, 9449, 847, 9295, 6590, 3448, 6144, 2950, 4122, 9947, 6834, 3085, 2526, 3376, 7729, 893, 47, 8641, 445, 2012, 7746, 6501, 6176, 1126, 6181, 1449, 3833, 2657, 6609, 7530, 7956, 8510, 7199, 147, 7744, 7329, 8572, 6182, 6985, 1202, 683, 2092, 4621, 6763, 7194, 7628, 147, 3505, 4743, 6375, 1801, 5256, 3353, 4434, 2300, 4887, 1168, 7501, 7488, 9531, 6430, 9262, 9324, 1599, 4197, 512, 7168, 7177, 7366, 4263, 370, 7125, 8985, 765, 1925, 8048, 3270, 6679, 1051, 6310, 6394, 1271, 7352, 7623, 6796, 2848, 1176, 9751, 2408, 2846, 52, 7751, 3046, 2852, 6158, 6768, 3193, 4029, 9546, 8949, 6930, 3553, 1329, 3315, 7609};
        int otv[1000];
        #else
        long n;
        sscanf(argv[1], "%ld", &n);
        int *otv = (int*)malloc(n * sizeof(int));
        int *a = (int*)malloc(n * sizeof(int));
        if((otv == NULL) || (a == NULL)) {
            printf("%d cant alloc space!\n", rank);
            exit(-1);
        }
        srand(time(NULL));
        int left, right;
        sscanf(argv[2], "%d", &left);
        sscanf(argv[3], "%d", &right);
        for(i = 0; i < n; i++) {
            a[i] = left + rand()%(right - left + 1);
        }
        #endif
        double start, end;
        start = MPI_Wtime();
        int size = n / np;
        for(i = 1; i < np; i++) {
            MPI_Send(&size, 1, MPI_INT, i, 0, MPI_COMM_WORLD);
        }
        for(i = 1; i < np; i++) {
            MPI_Send(a + (i - 1) * size, size, MPI_INT, i, 0, MPI_COMM_WORLD);
        }
        qsort(a + size * (np - 1), size + (n % np), sizeof(int), compare);
        for(i = 1; i < np; i++) {
            MPI_Recv(a + (i - 1) * size, size, MPI_INT, i, 0, MPI_COMM_WORLD, &status);
        }
        int *p = (int*)calloc(np, sizeof(int));
        if(p == NULL) {
            printf("%d cant alloc space!\n", rank);
            exit(-1);
        }
        int mi, pmi, f, num;
        for(num = 0; num < n; num++) {
            f = 1;
            for(i = 0; i < np - 1; i++) {
                if(p[i] < size) {
                    if(f) {
                        f = 0;
                        pmi = i;
                        mi = i * size + p[i];
                    } else if(compare((const void *)(a + i * size + p[i]), (const void *)(a + mi)) < 0) {
                        pmi = i;
                        mi = i * size + p[i];
                    }
                }
            }
            if(p[np - 1] < size + (n % np)) {
                //i = np - 1
                if(f) {
                    f = 0;
                    pmi = i;
                    mi = i * size + p[i];
                } else if(compare((const void *)(a + i * size + p[i]), (const void *)(a + mi)) < 0) {
                    pmi = i;
                    mi = i * size + p[i];
                }
            }
            p[pmi] += 1;
            otv[num] = a[mi];
        }
        end = MPI_Wtime();
        printf("Np = %d, len = %d\nSort time = %lg seconds\n", np, n, end - start);
        free(p);
        free(a);
        if(check(otv, n)) {
            printf("Result: OK!\n");
        } else {
            printf("Result: ERROR!\n");
        }
        free(otv);
    }
    MPI_Finalize();
    return 0;
}
